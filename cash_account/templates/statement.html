{% extends 'base.html' %}
{% block header_title %}
  Extrato
{% endblock %}

{% block content %}
  <section class="flex-1 overflow-y-auto p-6">
    <div class="max-w-7xl mx-auto">
      <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-slate-200/60 mb-6">
        <form
          hx-get="{% url 'filter_transactions' %}"
          hx-target="#transactions-list"
          hx-trigger="change delay:300ms, keyup delay:300ms"
        >
          <div class="p-6">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
              <div class="flex-1 max-w-md">
                <div class="relative">
                  <button class="cursor-pointer absolute inset-y-0" type="button">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2"
                         stroke-linecap="round" stroke-linejoin="round"
                         class="lucide lucide-search absolute left-3 top-3 h-4 w-4 text-gray-400">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.3-4.3"></path>
                    </svg>
                  </button>
                  <input
                    id="search-input"
                    placeholder="Buscar transações..."
                    name="search"
                    type="text"
                    value=""
                    class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
              </div>

              <div class="flex gap-2">
                <button
                  type="button"
                  hx-on="click: document.getElementById('filters-section').classList.toggle('hidden')"
                  id="filters-btn"
                  class="flex items-center px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                >
                  <svg xmlns="http://www.w3.org/2000/svg"
                       width="24" height="24" viewBox="0 0 24 24"
                       fill="none" stroke="currentColor" stroke-width="2"
                       stroke-linecap="round" stroke-linejoin="round"
                       class="lucide lucide-filter h-4 w-4 mr-2">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                  </svg>
                  Filtros
                </button>

                <button
                  {% if not transactions %}disabled{% endif %}
                  formaction="{% url 'export_to_pdf' %}"
                  formtarget="blank"
                  type="submit"
                  id="export-btn"
                  class="flex items-center px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <svg xmlns="http://www.w3.org/2000/svg"
                       width="24" height="24" viewBox="0 0 24 24"
                       fill="none" stroke="currentColor" stroke-width="2"
                       stroke-linecap="round" stroke-linejoin="round"
                       class="lucide lucide-download h-4 w-4 mr-2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" x2="12" y1="15" y2="3"></line>
                  </svg>
                  Exportar
                </button>
              </div>
            </div>

            <div id="filters-section" class="mt-6 pt-6 border-t border-gray-200 hidden">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de transação</label>
                  <select
                    id="filter-type"
                    name="type"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="">Todas</option>
                    {% for key, value in types.items %}
                      <option value="{{ key }}" {% if key|stringformat:"s" == selected_type %}selected{% endif %}>{{ value }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Método de pagamento</label>
                  <select
                    id="filter-category"
                    name="transaction_method"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="">Todas</option>
                    {% for transaction in transactions_method %}
                      <option value="{{ transaction.id }}" {% if transaction.id|stringformat:"s" == selected_method %}selected{% endif %}>{{ transaction.get_type_display }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Data inicial</label>
                  <div class="relative">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2"
                         stroke-linecap="round" stroke-linejoin="round"
                         class="lucide lucide-calendar absolute left-3 top-3 h-4 w-4 text-gray-400">
                      <path d="M8 2v4"></path>
                      <path d="M16 2v4"></path>
                      <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                      <path d="M3 10h18"></path>
                    </svg>
                    <input
                      type="date"
                      id="date-from"
                      name="initial_date"
                      class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Data final</label>
                  <div class="relative">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2"
                         stroke-linecap="round" stroke-linejoin="round"
                         class="lucide lucide-calendar absolute left-3 top-3 h-4 w-4 text-gray-400">
                      <path d="M8 2v4"></path>
                      <path d="M16 2v4"></path>
                      <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                      <path d="M3 10h18"></path>
                    </svg>
                    <input
                      type="date"
                      id="date-to"
                      name="end_date"
                      class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                  </div>
                </div>
              </div>

              <div class="mt-4 flex gap-2">
                <button
                  id="clear-filters"
                  class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900 transition-colors"
                >
                  Limpar filtros
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-slate-200/60 p-6 hover:shadow-2xl transition-all duration-300 hover:-translate-y-1">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Total de Transações</p>
              <p class="text-2xl font-bold text-gray-900">{{ transactions.count }}</p>
            </div>
            <div class="p-3 bg-blue-100 rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg"
                   width="24" height="24" viewBox="0 0 24 24"
                   fill="none" stroke="currentColor" stroke-width="2"
                   stroke-linecap="round" stroke-linejoin="round"
                   class="lucide lucide-arrow-up-right h-6 w-6 text-blue-600">
                <path d="M7 7h10v10"></path>
                <path d="M7 17 17 7"></path>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-slate-200/60 p-6 hover:shadow-2xl transition-all duration-300 hover:-translate-y-1">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Total Receitas</p>
              <p class="text-2xl font-bold text-green-600">R$ {{ total_income|floatformat:2 }}</p>
            </div>
            <div class="p-3 bg-green-100 rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg"
                   width="24" height="24" viewBox="0 0 24 24"
                   fill="none" stroke="currentColor" stroke-width="2"
                   stroke-linecap="round" stroke-linejoin="round"
                   class="lucide lucide-arrow-up-right h-6 w-6 text-green-600">
                <path d="M7 7h10v10"></path>
                <path d="M7 17 17 7"></path>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-slate-200/60 p-6 hover:shadow-2xl transition-all duration-300 hover:-translate-y-1">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Total Despesas</p>
              <p class="text-2xl font-bold text-red-600">R$ {{ total_expense|floatformat:2 }}</p>
            </div>
            <div class="p-3 bg-red-100 rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg"
                   width="24" height="24" viewBox="0 0 24 24"
                   fill="none" stroke="currentColor" stroke-width="2"
                   stroke-linecap="round" stroke-linejoin="round"
                   class="lucide lucide-arrow-down-right h-6 w-6 text-red-600">
                <path d="m7 7 10 10"></path>
                <path d="M17 7v10H7"></path>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow border border-gray-200">
        <div class="p-5 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-700 text-center">Transações</h3>
        </div>
        <div class="overflow-x-auto">
          <div id="transactions-list">
            {% include 'partials/_transaction_items.html' %}
          </div>
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block script %}
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script>
    document.body.addEventListener('htmx:afterSwap', function(event) {
      if (event.detail.target.id === 'transactions-list') {
        const transactionsContainer = document.getElementById('transactions-list');
        const exportButton = document.getElementById('export-btn');
        const hasTransactions = transactionsContainer.querySelectorAll('.t-item').length > 0;

        if (hasTransactions) {
          exportButton.removeAttribute('disabled');
        } else {
          exportButton.setAttribute('disabled', true);
        }
      }
    });
  </script>
{% endblock script %}