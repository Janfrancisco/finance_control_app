{% extends 'base.html' %}

{% block header_title %}
  Dashboard
{% endblock %}

{% block content %}
  <section class="flex-1 overflow-y-auto overflow-x-hidden p-6">
    <div class="max-w-7xl mx-auto">
      <!-- Header -->
      <div class="mb-8">
        <p class="text-slate-600 text-lg">Visão geral das suas finanças</p>
      </div>

      <!-- Summary Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        
        <!-- Current Balance -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-slate-200/60 
                    hover:shadow-2xl transition-all duration-300 hover:-translate-y-1">
          <div class="flex items-center justify-between p-6 pb-2">
            <h3 class="text-sm font-semibold text-slate-600 uppercase tracking-wide">Saldo Total</h3>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round"
                 class="h-5 w-5 text-slate-400">
              <line x1="12" x2="12" y1="2" y2="22"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
          </div>
          <div class="px-6 pb-4">
            <div class="text-2xl font-bold bg-gradient-to-r from-emerald-600 to-teal-600 
                        bg-clip-text text-transparent">
              R$ {{ current_balance|floatformat:2 }}
            </div>
            <p class="text-xs text-slate-500 mb-2 mt-4 font-medium">Composição do Saldo Total</p>
            <canvas id="totalBalanceChart"></canvas>
          </div>
        </div>

        <!-- Total Income -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-slate-200/60 
                    hover:shadow-2xl transition-all duration-300 hover:-translate-y-1">
          <div class="flex items-center justify-between p-6 pb-2">
            <h3 class="text-sm font-semibold text-slate-600 uppercase tracking-wide">Receitas</h3>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-emerald-600">
              <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline>
              <polyline points="16 7 22 7 22 13"></polyline>
            </svg>
          </div>
          <div class="px-6 pb-6">
            <div class="text-2xl font-bold text-emerald-600">
              R$ {{ total_income|floatformat:2 }}
            </div>
            <p class="text-xs text-slate-500 mb-2 mt-4 font-medium">
              Distribuição Total das Entradas
            </p>
            <canvas id="totalIncomeChart"></canvas>
          </div>
        </div>

        <!-- Total Expense -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-slate-200/60 
                    hover:shadow-2xl transition-all duration-300 hover:-translate-y-1">
          <div class="flex items-center justify-between p-6 pb-2">
            <h3 class="text-sm font-semibold text-slate-600 uppercase tracking-wide">Despesas</h3>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-rose-600">
              <polyline points="22 17 13.5 8.5 8.5 13.5 2 7"></polyline>
              <polyline points="16 17 22 17 22 11"></polyline>
            </svg>
          </div>
          <div class="px-6 pb-6">
            <div class="text-2xl font-bold text-rose-600">
              R$ {{ total_expense|floatformat:2 }}
            </div>
            <p class="text-xs text-slate-500 mb-2 mt-4 font-medium">
              Distribuição Total das Saídas
            </p>
            <canvas id="totalExpenseChart"></canvas>
          </div>
        </div>

        <!-- Transaction Method -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl border border-slate-200/60 
                    hover:shadow-2xl transition-all duration-300 hover:-translate-y-1">
          <div class="flex items-center justify-between p-6 pb-2">
            <h3 class="text-sm font-semibold text-gray-600">Método de Transação</h3>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-sky-600">
              <rect width="20" height="14" x="2" y="5" rx="2"></rect>
              <line x1="2" x2="22" y1="10" y2="10"></line>
            </svg>
          </div>

          <div class="px-6 pb-6 space-y-4">
            <!-- PIX Usage -->
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                <span class="text-sm font-medium text-gray-700">PIX</span>
              </div>
              <div class="text-right">
                <div class="text-lg font-bold text-gray-900 tabular-nums">
                  R$ {{ total_pix|floatformat:2 }}
                </div>
                <div class="text-xs text-gray-500 tabular-nums">
                  {{ percent_pix }}% do total
                </div>
              </div>
            </div>

            <!-- Cash Usage -->
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-2">
                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                <span class="text-sm font-medium text-gray-700">Dinheiro</span>
              </div>
              <div class="text-right">
                <div class="text-lg font-bold text-gray-900 tabular-nums">
                  R$ {{ total_cash|floatformat:2 }}
                </div>
                <div class="text-xs text-gray-500 tabular-nums">
                  {{ percent_cash }}% do total
                </div>
              </div>
            </div>

            <!-- Most Used Method -->
            <div class="pt-2 border-t border-gray-100">
              <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-amber-500"><path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"></path></svg>
                <span class="text-xs text-gray-600">
                  Método preferido:
                  <span class="font-medium text-gray-900">
                    {{ most_used_method }}
                  </span>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      {% include 'partials/finance_overview.html' %}
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block script %}
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const totalCash = parseFloat('{{ total_cash|default:0 }}'.replace(/\./g, '').replace(',', '.')) || 0;
    const totalPix = parseFloat('{{ total_pix|default:0 }}'.replace(/\./g, '').replace(',', '.')) || 0;
    const cash_income = parseFloat('{{ cash_income|default:0 }}'.replace(/\./g, '').replace(',', '.')) || 0;
    const cash_expense = parseFloat('{{ cash_expense|default:0 }}'.replace(/\./g, '').replace(',', '.')) || 0;
    const pix_income = parseFloat('{{ pix_income|default:0 }}'.replace(/\./g, '').replace(',', '.')) || 0;
    const pix_expense = parseFloat('{{ pix_expense|default:0 }}'.replace(/\./g, '').replace(',', '.')) || 0;

    // Função para formatar valores como moeda BRL
    const formatBRL = (value) => {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(value);
    };

    const chartOptions = {
      responsive: true,
      plugins: {
        legend: {
          position: "bottom",
          align: "center",
          labels: {
            boxWidth: 20,
            boxHeight: 12,
            padding: 16,
            font: {
              size: 12,
              family: 'Arial',
            },
            color: '#6c757d',
          },
        },
        tooltip: {
          callbacks: {
            label: function (context) {
              let label = context.label || '';
              let value = context.raw;
              return `${label}: ${formatBRL(value)}`;
            }
          }
        },
        // Exibe o valor formatado no centro do gráfico (opcional)
        datalabels: {
          color: '#333',
          font: { weight: 'bold' },
          formatter: (value) => formatBRL(value)
        }
      },
    };

    // Total Balance Chart
    new Chart(document.getElementById('totalBalanceChart'), {
      type: 'doughnut',
      data: {
        labels: ['Dinheiro', 'Pix'],
        datasets: [{
          data: [totalCash, totalPix],
          backgroundColor: ["#10b981", "#e5e7eb"],
          borderWidth: 1,
        }],
      },
      options: chartOptions,
    });

    // Total Income Chart
    new Chart(document.getElementById('totalIncomeChart'), {
      type: 'doughnut',
      data: {
        labels: ['Dinheiro', 'Pix'],
        datasets: [{
          data: [cash_income, pix_income],
          backgroundColor: ["#10b981", "#e5e7eb"],
          borderWidth: 1,
        }],
      },
      options: chartOptions,
    });

    // Total Expense Chart
    new Chart(document.getElementById('totalExpenseChart'), {
      type: 'doughnut',
      data: {
        labels: ['Dinheiro', 'Pix'],
        datasets: [{
          data: [cash_expense, pix_expense],
          backgroundColor: ["#f43f5e", "#e5e7eb"],
          borderWidth: 1,
        }],
      },
      options: chartOptions,
    });
  });
</script>

{% endblock %}
